<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        canvas {
            border: 1px black solid;
        }
    </style>
    <script src="./game.js"></script>
    <script src="./ball.js"></script>
    <script src="./block.js"></script>
    <script src="./paddle.js"></script>
    <script src="./utils.js"></script>
    <script src="./level.js"></script>
</head>

<body>
    <canvas id="id-canvas" width="1000" height="500"></canvas>
    调整fps(默认为60):
    <input type="range" id="id-input-speed" value="60">
</body>

</html>

<script>

    // 加载关卡
    let loadLevel = function (n) {
        n--
        let blockPos = level[n]
        let blocks = []
        for (let i = 0; i < blockPos.length; i++) {
            const pos = blockPos[i];
            let b = new Block('block.jpg', pos[0], pos[1], pos[2])
            blocks.push(b)
        }
        return blocks
    }

    let paused = false

    let enableDebugMode = function (enable, blocks) {
        if (!enable) {
            return
        }
        // 暂停功能
        window.addEventListener('keydown', function (event) {
            let k = event.key
            if (k === 'p') {
                paused = !paused
                log('暂停/启动')
            } else if ('12345'.includes(k)) {
                log(`载入第${k}关`)
                // 清空数组
                blocks.length = 0
                let levelK = loadLevel(Number(k))
                for (const i in levelK) {
                    blocks[i] = levelK[i]
                }
            }
        })

        document.querySelector('#id-input-speed').addEventListener('input', function (event) {
            let curFps = Number(event.target.value) + 1
            window.fps = curFps
            log(`fps调整为${curFps}`)
        })
    }

    let _main = function () {

        let x = 100
        let y = 390
        let speed = 15

        let game = Game(60)
        // 构造一个板子
        let paddle = new Paddle('paddle.jpg', x, y, speed)
        let ball = new Ball('ball.jpg', x, y - 100, 4, 4)
        // 加载第一关
        let blocks = loadLevel(1)
        // 注册操作
        game.registerAction('a', function () {
            paddle.moveLeft()
        })
        game.registerAction('d', function () {
            paddle.moveRight()
        })
        game.registerAction('f', function () {
            ball.fire()
        })

        enableDebugMode(true, blocks)

        game.update = function () {
            if (paused) {
                return
            }
            ball.move()
            // 判断板子和球是否相撞
            if (paddle.collide(ball)) {
                // 反弹
                ball.rebound()
            }
            // 判断球和砖块是否相撞
            for (let i = 0; i < blocks.length; i++) {
                let b = blocks[i]
                if (b.collide(ball)) {
                    b.hit()
                    ball.rebound()
                }
            }
        }

        game.draw = function () {
            game.drawImage(paddle)
            game.drawImage(ball)
            for (let i = 0; i < blocks.length; i++) {
                let b = blocks[i]
                if (b.alive) {
                    game.drawImage(b)
                }
            }
        }
    }

    _main()
</script>